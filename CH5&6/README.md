# Lab 3.1 Using OllyDbg to Analyze Lab09-01.exe (25 pts)
## What you need
- A Windows machine, real or virtual. I tried this on Windows 7, 10, and Server 2008 and it works on them all.

## Summary

We're going to perform the first run-through of the lab09-01 from the book [practical malware analysis](https://www.amazon.com/Practical-Malware-Analysis-Dissecting-Malicious/dp/1593272901) 

We'll see an executable that checks for a registry key, if it doesn't exist, then the executable will delete itself.

## Get OllyDbg 1.10

Get OllyDbg 1.10 [here](http://www.ollydbg.de/download.htm)

**Don't waste your time on OllyDbg 2.00 or 2.01. They are both broken.**

## Finding the Main Entry Point

Open the Lab09-01.exe file in IDA Pro.

Click options --> General. Make sure "Line Prefixes" is check as the image below:

![Screenshot from 2024-02-08 07-41-01](https://github.com/Mr-Aflaton/tt/assets/93038351/8098caa2-9ddb-42c5-975d-c1deba19049d)

Click Windows, "Reset Desktop".

IDA Pro shows that main starts at 0x402AF0, as shown below: 

![s1](https://github.com/Mr-Aflaton/tt/assets/93038351/58ecfd15-3cf0-46d6-858f-116c1c20ff27)

## Saving the Screen Image

Make sure you can see the **0x402AF0** address, as shown above.

On your keyboard, press the PrntScrn key.

Click Start, type in PAINT, and open Paint.

Press Ctrl+V to paste in the image of your desktop.

YOU MUST SUBMIT WHOLE-DESKTOP IMAGES TO GET FULL CREDIT.

Save the image with a filename of "LAB3 1a YOUR NAME". 

## Using OllyDbg to Walk Through Quickly

Open Lab09-01.exe in OllyDbg.

You start at a preamble, which comes before the entry point you saw in IDA Pro, as shown below. 

![Screenshot from 2024-02-08 19-57-50](https://github.com/Mr-Aflaton/tt/assets/93038351/8e482a0c-ec2a-49a3-9e57-827bff09b676)

Press F8 forty times(to step over instructions), until you reach address 0x403933. In the upper left pane of OllyDbg, scroll down a few lines to show the code that sets the arguments and calls main, as highlighted below. 

![Screenshot from 2024-02-08 20-02-16](https://github.com/Mr-Aflaton/tt/assets/93038351/3f70bebd-5028-4c22-81fd-1c2e2833a1f7)

Press F7 five times to load parameters and call main from 0x403945, showing a new section of code starting at 0x402AF0, as shown below. 

![Screenshot from 2024-02-08 20-03-39](https://github.com/Mr-Aflaton/tt/assets/93038351/4907cb2c-4da2-413c-8065-b05d31cff4a6)

Press F7 twenty-one times to call a short subroutine and get to 0x402AFD, as shown below. 

This CMP operation is testing to see if the number of command-line arguments is 1. 

![Screenshot from 2024-02-08 20-04-47](https://github.com/Mr-Aflaton/tt/assets/93038351/71857ce8-c8df-409f-ac40-54d20ac36908)

Press F7 three times to pass the test and jump to 0x00401000, as shown below.

Now we are in the routine starting at 0x401000.

It calls RegOpenKeyExA at 0x40101B.

Left-click the line starting with 0x401021 and press F2 to put a breakpoint there. That address turns red, as shown below.

![Screenshot from 2024-02-08 20-10-47](https://github.com/Mr-Aflaton/tt/assets/93038351/e54e856a-5f97-4cc6-a42e-015988ecb891)

Left-click the line starting with 0x401000. Press F9 to run to the breakpoint. 
Look at the upper right to see the registers. EAX now contains 2, as shown below. 

![Screenshot from 2024-02-08 20-12-49](https://github.com/Mr-Aflaton/tt/assets/93038351/fef7148b-d19d-4c99-9986-c693c5efb928)

This is a "non-zero error code", as explained [here](http://msdn.microsoft.com/en-us/library/windows/desktop/ms724897(v=vs.85).aspx):

That means the test failed - it did not find the registry key it was looking for.

Press F7 three times to get to location 0x401027.

Press F7 to execute the JMP.

Press F7 three times to step through the subroutine and get to 0x402B08.

Press F7 three times to get to location 0x402410, as shown below: 

![Screenshot from 2024-02-08 20-14-03](https://github.com/Mr-Aflaton/tt/assets/93038351/c3cce8c7-4fbd-42b6-8340-06d98a04dafc)

 This function uses GetModuleFilename to get the path to the current executable and builds the ASCII string

```CMD
/c del path-to-executable >> NUL
```

To see that, place a breakpoint just after GetShortPathNameA, so its address turns red, as shown below. 

![Screenshot from 2024-02-08 20-18-27](https://github.com/Mr-Aflaton/tt/assets/93038351/1061c0cc-6937-482d-9343-ed81b2e13750)

Click the line starting with 0x402410 to highlight it.

Press F9 to run to the breakpoint.

You should now be at the line ending with "ASCII "/c del ", as show below.

![Screenshot from 2024-02-08 20-22-33](https://github.com/Mr-Aflaton/tt/assets/93038351/7ef2a39d-e39c-42e7-a870-a68523bbe9f0)

By holding F7 down or tapping it many times, you can play the code forward like a movie in slow motion.

Watch as the code slowly steps through a long path name in EDI. Then the path name flips quickly through several registers, ending up in EDX.

Stop when you see a string in EDX, starting with this:
```CMD
ASCII "/c del C:\
```
as shown below: 

![Screenshot from 2024-02-08 20-29-10](https://github.com/Mr-Aflaton/tt/assets/93038351/7d047d60-ac2f-414c-a8aa-b9e1867b7535)


### Pressing f7 too many times

If you press F7 too many times, EDX empties. To return to this point you must do these steps:
	- From the Ollydbg menu bar, click Debug, Restart
	- Click Yes
	- Press F9 to run to the breakpoint at 0x401021
	- Press F9 to run to the breakpoint at 0x402449
	- Hold down or tap F7 several dozen times to get to the desired point 

## Saving the screen image

Make sure you can see the EDX register with a value starting with ASCII "/c del C:\ as shown above.

On your keyboard, press the PrntScrn key.

Click Start, type in PAINT, and open Paint.

Press Ctrl+V to paste in the image of your desktop.

YOU MUST SUBMIT WHOLE-DESKTOP IMAGES TO GET FULL CREDIT.

Save the image with a filename of "LAB3 1b from YOUR NAME". 

# Turning in your submission

Email the images showing the secret messages to [csc@htu.edu.jo](mailto:csc@htu.edu.jo) with the subject line: `Lab 3 - YOUR NAME`
