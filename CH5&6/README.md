# Lab 3.1 Using OllyDbg to Analyze Lab09-01.exe (25 pts)
## What you need
- A Windows machine, real or virtual. I tried this on Windows 7, 10, and Server 2008 and it works on them all.

## Summary

We're going to perform the first run-through of the lab09-01 from the book [practical malware analysis](https://www.amazon.com/Practical-Malware-Analysis-Dissecting-Malicious/dp/1593272901) 

We'll see an executable that checks for a registry key, if it doesn't exist, then the executable will delete itself.

## Get OllyDbg 1.10

Get OllyDbg 1.10 [here](http://www.ollydbg.de/download.htm)

**Don't waste your time on OllyDbg 2.00 or 2.01. They are both broken.**

## Finding the Main Entry Point

Open the Lab09-01.exe file in IDA Pro.

Click options --> General. Make sure "Line Prefixes" is check as the image below:

![Screenshot from 2024-02-08 07-41-01](https://github.com/Cyber-Security-Club-HTU/CSC-Malware-Analysis/assets/93038351/7a823bb0-e429-402d-84ff-e06a69e1928e)

Click Windows, "Reset Desktop".

IDA Pro shows that main starts at 0x402AF0, as shown below: 

![Screenshot from 2024-02-08 19-50-28](https://github.com/Cyber-Security-Club-HTU/CSC-Malware-Analysis/assets/93038351/9a083e24-1615-4ce9-8c7d-d9b7a2e16858)



## Saving the Screen Image

Make sure you can see the **0x402AF0** address, as shown above.

On your keyboard, press the PrntScrn key.

Click Start, type in PAINT, and open Paint.

Press Ctrl+V to paste in the image of your desktop.

YOU MUST SUBMIT WHOLE-DESKTOP IMAGES TO GET FULL CREDIT.

Save the image with a filename of "LAB3 1a YOUR NAME". 

## Using OllyDbg to Walk Through Quickly

Open Lab09-01.exe in OllyDbg.

You start at a preamble, which comes before the entry point you saw in IDA Pro, as shown below. 

![Screenshot from 2024-02-08 19-57-50](https://github.com/Cyber-Security-Club-HTU/CSC-Malware-Analysis/assets/93038351/ade1ca0d-b4c3-492c-81b0-124c6ec124de)


Press F8 forty times(to step over instructions), until you reach address 0x403933. In the upper left pane of OllyDbg, scroll down a few lines to show the code that sets the arguments and calls main, as highlighted below. 
![Screenshot from 2024-02-08 20-02-16](https://github.com/Cyber-Security-Club-HTU/CSC-Malware-Analysis/assets/93038351/d0af76ff-c583-48d4-84cb-0549b496b558)

Press F7 five times to load parameters and call main from 0x403945, showing a new section of code starting at 0x402AF0, as shown below. 

![Screenshot from 2024-02-08 20-03-39](https://github.com/Cyber-Security-Club-HTU/CSC-Malware-Analysis/assets/93038351/d3160bc3-1eba-41aa-8d7b-adfe0aec8feb)


Press F7 twenty-one times to call a short subroutine and get to 0x402AFD, as shown below. 

This CMP operation is testing to see if the number of command-line arguments is 1. 

![Screenshot from 2024-02-08 20-04-47](https://github.com/Cyber-Security-Club-HTU/CSC-Malware-Analysis/assets/93038351/ae033964-888c-42f2-8dc2-b6f59cb6c177)


Press F7 three times to pass the test and jump to 0x00401000, as shown below.

Now we are in the routine starting at 0x401000.

It calls RegOpenKeyExA at 0x40101B.

Left-click the line starting with 0x401021 and press F2 to put a breakpoint there. That address turns red, as shown below.

![Screenshot from 2024-02-08 20-10-47](https://github.com/Cyber-Security-Club-HTU/CSC-Malware-Analysis/assets/93038351/0fece849-a35a-43b5-ba63-717d5c2fc1d3)


Left-click the line starting with 0x401000. Press F9 to run to the breakpoint. 
Look at the upper right to see the registers. EAX now contains 2, as shown below. 

![Screenshot from 2024-02-08 20-12-49](https://github.com/Cyber-Security-Club-HTU/CSC-Malware-Analysis/assets/93038351/305a3eb0-4d02-4c31-98b5-9ff08b3ab037)


This is a "non-zero error code", as explained [here](http://msdn.microsoft.com/en-us/library/windows/desktop/ms724897(v=vs.85).aspx):

That means the test failed - it did not find the registry key it was looking for.

Press F7 three times to get to location 0x401027.

Press F7 to execute the JMP.

Press F7 three times to step through the subroutine and get to 0x402B08.

Press F7 three times to get to location 0x402410, as shown below: 

![Screenshot from 2024-02-08 20-14-03](https://github.com/Cyber-Security-Club-HTU/CSC-Malware-Analysis/assets/93038351/0815f580-723a-4dca-bd38-0d908b28f494)


 This function uses GetModuleFilename to get the path to the current executable and builds the ASCII string

```CMD
/c del path-to-executable >> NUL
```

To see that, place a breakpoint just after GetShortPathNameA, so its address turns red, as shown below. 

![Screenshot from 2024-02-08 20-18-27](https://github.com/Cyber-Security-Club-HTU/CSC-Malware-Analysis/assets/93038351/3ab6b4d5-c7c9-46a4-a7ff-3d642a9e105c)

Click the line starting with 0x402410 to highlight it.

Press F9 to run to the breakpoint.

You should now be at the line ending with "ASCII "/c del ", as show below.

![Screenshot from 2024-02-08 20-22-33](https://github.com/Cyber-Security-Club-HTU/CSC-Malware-Analysis/assets/93038351/5885d452-0dcb-4f3e-a309-dba2d1bbc5e9)

By holding F7 down or tapping it many times, you can play the code forward like a movie in slow motion.

Watch as the code slowly steps through a long path name in EDI. Then the path name flips quickly through several registers, ending up in EDX.

Stop when you see a string in EDX, starting with this:
```CMD
ASCII "/c del C:\
```
as shown below: 


![Screenshot from 2024-02-08 20-29-10](https://github.com/Cyber-Security-Club-HTU/CSC-Malware-Analysis/assets/93038351/17a93dd0-b55d-4802-8247-dbc078c01327)


### Pressing f7 too many times

If you press F7 too many times, EDX empties. To return to this point you must do these steps:
	- From the Ollydbg menu bar, click Debug, Restart
	- Click Yes
	- Press F9 to run to the breakpoint at 0x401021
	- Press F9 to run to the breakpoint at 0x402449
	- Hold down or tap F7 several dozen times to get to the desired point 

## Saving the screen image

Make sure you can see the EDX register with a value starting with ASCII "/c del C:\ as shown above.

On your keyboard, press the PrntScrn key.

Click Start, type in PAINT, and open Paint.

Press Ctrl+V to paste in the image of your desktop.

YOU MUST SUBMIT WHOLE-DESKTOP IMAGES TO GET FULL CREDIT.

Save the image with a filename of "LAB3 1b from YOUR NAME". 




# Lab 3.2 WinDbg Preview: Source-Level Debugging (25 pts)
## What you need
- A Windows 10 machine

## Summary

We're going to use WinDbg Preview for user-land debugging.

## Get WinDbg Preview and Visual Studio 2019

If you are using the Windows 10 with Tools machine from your instructor, WinDbg Preview and Visual Studio 2019 are already installed.

If you are using some other machine, make sure they're installed.

## Preparing to Compile C++ Code

Click **Start**, write `x64` and choose `x64 Native Tools Command Prompt for VS 2019`


## Creating C++ Program

In the "x64 Native Tools Command Prompt" window, execute these commands: 

```CMD
mkdir C:\MyApp
cd C:\MyApp
notepad MyApp.cpp
```

Click Yes to create a new file.

Paste in this code, as shown below. 

```C++
void MyFunction(long p1, long p2, long p3)
{
    long x = p1 + p2 + p3;
    long y = 0;
    y = x / p2;
}

void main ()
{
    long a = 2;
    long b = 0;
    MyFunction(a, b, 5);
}
```

![Screenshot from 2024-02-17 05-01-24](https://github.com/Cyber-Security-Club-HTU/CSC-Malware-Analysis/assets/93038351/5d37c8bf-b252-44df-933c-107d26327479)

In Notepad, save the file. 

## Compiling a C++ Program Without Symbols

In the "x64 Native Tools Command Prompt" window, execute these commands: 

```CMD
cl MyApp.cpp
dir
```

As shown below, the compilation process created an .exe file and an .obj files, but no .pdb file. 

![Screenshot from 2024-02-17 05-02-09](https://github.com/Cyber-Security-Club-HTU/CSC-Malware-Analysis/assets/93038351/1ad126c1-e2f5-4ab8-9fbf-dbff49113a1b)

## Loading MyApp in WinDbg

Click the Start button and type WIN. Click "WinDbg Preview". 

In WinDbg, click File, "Launch executable". Navigate to: `C:\MyApp\MyApp.exe ` and double-click it. 

The app loads, and stops inside ntdll, as shown below.

![Screenshot from 2024-02-17 05-05-24](https://github.com/Cyber-Security-Club-HTU/CSC-Malware-Analysis/assets/93038351/85511f23-c7c5-47eb-afd7-c22e86e8c8e4)



## Finding "main" symbols in MyApp

In the lower center of WinDbg, execute these commands: 

```
x MyApp!*main*
x MyApp!*
```

There are no results, as shown below. 

![Screenshot from 2024-02-17 05-07-22](https://github.com/Cyber-Security-Club-HTU/CSC-Malware-Analysis/assets/93038351/9bad93b6-d1d6-4d7d-8447-ef8ad3f9016d)


To see the problem, execute this command: 

```CMD
lm
```

The "MyApp" module is loaded, but it has no symbols, as shown below.

This makes it difficult to find the MyApp code. 

![Screenshot from 2024-02-17 05-08-22](https://github.com/Cyber-Security-Club-HTU/CSC-Malware-Analysis/assets/93038351/3aa6fc1f-f5c9-463d-9ca8-aebe6f1636b7)


Close WinDbg. This is necessary because it locks the MyApp.exe file. 

## Compiling a C++ Program with Symbols

In the "x64 Native Tools Command Prompt" window, execute these commands:

```CMD
del MyApp.obj
del MyApp.exe
cl /Zi MyApp.cpp
dir
```


As shown below, the compilation process created an .exe file and two .pdb files, which contain debugging symbols. 

![Screenshot from 2024-02-17 05-09-57](https://github.com/Cyber-Security-Club-HTU/CSC-Malware-Analysis/assets/93038351/bb10e68c-7e6e-48b2-a78a-15171b806f47)

## Loading the newly compiled MyApp

Click the Start button and type WIN. Click "WinDbg Preview". 

In WinDbg, click File, "Launch executable". Navigate to: `C:\MyApp\MyApp.exe ` and double-click it. 

The app loads, and stops inside ntdll, as previously.

## Finding "main" symbols in MyApp

In the lower center of WinDbg, execute this command:

```CMD
x MyApp!*main*
```

Now it finds symbols, including MyApp!main, as shown below. 

![Screenshot from 2024-02-17 05-12-48](https://github.com/Cyber-Security-Club-HTU/CSC-Malware-Analysis/assets/93038351/e9adb235-5cf7-48a4-8f6f-035849aa27d5)


## Setting a Breakpoint and Running To It

In the lower center of WinDbg, execute this command:

```CMD
bu MyApp!main
```

In WinDbg, at the top left, click Go.

The app runs to the start of main(), and the top left pane shows the C++ source code, with the breakpoint and current instruction highlighted, as shown below.

At the lower left, notice the "Locals" pane. This shows the local variables. Right now they contain zeroes. 

![Screenshot from 2024-02-17 05-13-55](https://github.com/Cyber-Security-Club-HTU/CSC-Malware-Analysis/assets/93038351/79ca3834-868b-45ca-9124-15cd5a8ced81)

## Stepping Through the Code

In WinDbg, at the top left, click "Step Into" twice.

As shown below, the program proceeds to line 11 of the source code. The variable a is now set to 2. 

![Screenshot from 2024-02-17 05-14-43](https://github.com/Cyber-Security-Club-HTU/CSC-Malware-Analysis/assets/93038351/f6c8b617-6100-4273-ac21-7f5b57958c96)

In WinDbg, at the top left, click "Step Into" several more times, until the program executes source line 5.

The program cannot execute this instruction because of an error (It's hidden now).
![Screenshot from 2024-02-17 05-16-35](https://github.com/Cyber-Security-Club-HTU/CSC-Malware-Analysis/assets/93038351/23470946-05a9-4a74-a980-d9bd285447d8)

## Saving the Screen Image

Make sure you have the full error as show in the image. 

On your keyboard, press the PrntScrn key.

Click Start, type in PAINT, and open Paint.

Press Ctrl+V to paste in the image of your desktop.

YOU MUST SUBMIT WHOLE-DESKTOP IMAGES TO GET FULL CREDIT.

Save the image with a filename of "LAB3 2a YOUR NAME".

# Turning in your submission

Email the images showing the secret messages to [csc@htu.edu.jo](mailto:csc@htu.edu.jo) with the subject line: `Lab 3 - YOUR NAME`

