Lab 2.1: IDA (20 Points)
=============================================

What you need:

*   A Windows machine, real or virtual machine.
*   The textbook: "Practical Malware Analysis"

Purpose
-------

You will practice using IDA Pro.

You should already have the lab files in your VM.

Downloading and Installing IDA Pro
----------------------------------

IDA is already installed in your VM, if not found:

In your Windows machine, open a Web browser and go to

[https://www.hex-rays.com/products/ida/support/download\_freeware.shtml](https://www.hex-rays.com/products/ida/support/download_freeware.shtml)

Download "**IDA Freeware**" and install it.

If that link is down, use this alternate download link:

Follow the Textbook
-------------------

Follow the instructions for **Lab 5-1** in the textbook, questions 1-8, to analyze Lab05-01.dll using only IDA Pro. There are more detailed solutions in the back of the book.

Opening Lab05-01.dll in IDA Pro
-------------------------------

- Launch IDA Pro. 

- Click **OK**. 

- Click **New**. 

- Click the "**PE Dynamic Library**" icon and click **OK**.

- Navigate to Lab05-01.dll and open it.

Q 1: Finding the Address of DLLMain
-----------------------------------

In IDA Pro, click **Windows**, "**Functions window**".

Click the "**Function name**" header to sort by name and scroll to the top.

Your image should show the location of DLLMain, as shown below:

![image](https://github.com/Cyber-Security-Club-HTU/CSC-Malware-Analysis/assets/75253629/a2d1ffeb-e95c-410d-a6a0-3e7158095331)

Press the **PrntScrn** key to capture an image of the whole desktop.

Open Paint and paste the image in with **Ctrl+V**.

Save this image with the filename "**Lab2.1 6a YOUR NAME**".

**YOU MUST SUBMIT WHOLE-DESKTOP IMAGES TO GET FULL CREDIT!**

Q 2: Find the import for gethostbyname
--------------------------------------

In IDA Pro, click **Windows**, **Imports**. Click the **Name** header to sort by name. Find "gethostbyname" -- note that capital letters and lowercase letters sort into separate groups.

Widen the **Address** column to make the entire address visible.

Your image should show the location of gethostbyname, as shown below:

![image](https://github.com/Cyber-Security-Club-HTU/CSC-Malware-Analysis/assets/75253629/fbcf2826-3992-4d08-af1e-d2b2eda91352)

Save a full-desktop image with the filename "**Lab2.1 6b YOUR NAME**".

Q 5: Count Local Variables for the Subroutine at 0x10001656
-----------------------------------------------------------

In IDA Pro, click **Windows**, "**IDA View-A**". Press the **SPACEBAR** to get to text view.

Press **g** to Go. Enter the address **0x10001656** and click **OK**.

Scroll up to show the comments IDA added to the start of the function, listing its local variables, as shown below:

![image](https://github.com/Cyber-Security-Club-HTU/CSC-Malware-Analysis/assets/75253629/543b5335-4984-46b3-91b8-114023b82b5c)

Save a full-desktop image with the filename "**Lab2.1 6c  YOUR NAME**".

Q 8: Finding the Purpose of the Code that References \\cmd.exe /c
-----------------------------------------------------------------

In IDA Pro, click **Windows**, **Strings**. Make the window larger. Sort by **String**. Find the String "**\\\\cmd.exe /c**" and double-click it. The function opens in text view, as shown below.

In the line containing "\\\\cmd.exe /c", double-click the address to the right of "XREF", as indicated by the red outline in the image below.

![image](https://github.com/Cyber-Security-Club-HTU/CSC-Malware-Analysis/assets/75253629/2fffed91-c744-46a8-8426-36a2effe601c)

Press the **SPACEBAR** to get to graph view, as shown below. "\\\\cmd.exe /c" is used in the little routine on the left.

![image](https://github.com/Cyber-Security-Club-HTU/CSC-Malware-Analysis/assets/75253629/cc1c1698-1c3a-4835-9c1a-3f48d274e80f)

Drag the graph view down to see the subroutines before it. About three boxes up you should find text beginning with "Hi, Master", as shown below.

![image](https://github.com/Cyber-Security-Club-HTU/CSC-Malware-Analysis/assets/75253629/d7d9602a-6cda-4446-8c3c-bfff2f992369)

Double-click **aHiMasterDDDD** to find the complete message. The purpose of the malware is clearly stated.

Your image should show what the code is doing, as shown below. The purpose is behind the red rectangle in the image below.

![image](https://github.com/Cyber-Security-Club-HTU/CSC-Malware-Analysis/assets/75253629/5874382f-e497-4d23-9d56-fd1a2bf7e252)

Save a full-desktop image with the filename "**Lab2.1 6d YOUR NAME**".

Turning in your Lab
-----------------------

Email the images showing to csc@htu.edu.jo with the subject line: **Lab2.1 YOUR NAME**


Lab 2.2: Malware Behavior (20 points)
==============================================

What you need:

*   The Windows VM
*   The textbook: "Practical Malware Analysis"


Static Analysis with Strings
----------------------------

Examine the strings in Lab11-01.exe.

One handy tool to do that is [**BinText**](https://www.mcafee.com/hk/downloads/free-tools/bintext.aspx).

You should find the two items below.

Save an image showing the string **SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon** as shown below, with the filename "**Lab2.2 14a YOUR NAME**".

**YOU MUST SUBMIT WHOLE-DESKTOP IMAGES TO GET FULL CREDIT!**

![image](https://github.com/Cyber-Security-Club-HTU/CSC-Malware-Analysis/assets/75253629/7cbc6390-f59e-41ce-abb7-f86b0af748a9)

Save an image showing the string **gina.DLL**, as shown below, with the filename "**Lab2.2 14b YOUR NAME**".

![image](https://github.com/Cyber-Security-Club-HTU/CSC-Malware-Analysis/assets/75253629/ba58db0c-5e51-4631-9dd3-8ac87e0dd327)

These strings suggest that this is GINA interception malware.

Static Analysis with PEview
---------------------------

Examine the Lab11-01.exe file in PEview. Find the items below.

Save an image showing these imports, as highlighted below:, with the filename "**Lab2.2 14c YOUR NAME**".

*   **RegSetValueExA**
*   **RegCreateKeyExA**
*   **SizeofResource**
*   **LockResource**
*   **LoadResource**

![image](https://github.com/Cyber-Security-Club-HTU/CSC-Malware-Analysis/assets/75253629/4773fdce-c168-42c4-a348-846c5806c546)

These API calls suggest that the malware is manipulating the registry and extracting a resource section.

Save an image showing the **BINARY TGAD 0000** section, as shown below, with the filename "**Lab2.2 14d YOUR NAME**".

![image](https://github.com/Cyber-Security-Club-HTU/CSC-Malware-Analysis/assets/75253629/7cb1c1d8-e7fc-455f-8214-357a3e7e8825)

This is a PE file, concealed within a resource section.

Dynamic Analysis with Procmon
-----------------------------

Run the malware in a virtual machine, while running Procmon to see what it does.

In Procmon, click **Filter**, "**Reset Filter**".

Click **Filter**, **Filter**. Filter for a "**Process Name**" of **Lab11-01.exe**.

Save an image showing these events, as shown below, with the filename "**Lab2.2 14e YOUR NAME**".

*   **CreateFile ... msgina32.dll** or **IRP\_MU\_CREATE ... msgina.dll**
*   **RegCreateKey HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon**
*   **RegSetValue HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\GinaDLL**

![image](https://github.com/Cyber-Security-Club-HTU/CSC-Malware-Analysis/assets/75253629/ffaa81d8-d9a4-4d14-b490-5ffde0ef387a)

These actions create a file named **msgina.dll** and insert a path to that file into registry keys that will launch the DLL when the system boots up.

Resource Hacker
---------------

Next we'll use Resource Hacker to extract the gina.dll file.

Download Resource Hacker here:

[http://www.angusj.com/resourcehacker/](http://www.angusj.com/resourcehacker/)

Open **Lab11-01.exe** in Resource Hacker.

The "**BINARY TGAD 0**" starts with **MZ** and contains the telltale text "This program cannot be run in DOS mode", as shown below--this is an EXE file.

Save an image showing the "**BINARY TGAD 0**" section, as shown below, with the filename "**Lab2.2 14f YOUR NAME**".

![image](https://github.com/Cyber-Security-Club-HTU/CSC-Malware-Analysis/assets/75253629/463e21a2-afe8-4718-9048-9638563b589e)

In Resource Hacker, in the left pane, click **0** to highlight it, as shown above.

Click **Action**, **Save Resource as a binary file...**".

Save the file as **YOURNAME-TGAD0.exe**, replacing the text "YOURNAME" with your own name.

HashCalc
--------

If you don't have it, get HashCalc here:

[http://www.slavasoft.com/hashcalc/](http://www.slavasoft.com/hashcalc/)

Calculate the MD5 hash of the msgina32.dll file created by running the malware.

The MD5 hash begins with **7ce4**, as shown below.

![image](https://github.com/Cyber-Security-Club-HTU/CSC-Malware-Analysis/assets/75253629/554859f1-4768-4886-99fb-d8c74156ca8d)

Calculate the MD5 hash of the **YOURNAME-TGAD0.exe** file, as shown below.

Save an image showing these elements:

*   A filename containing **YOURNAME** (you will have to make the window very wide to show it if your malware samples are on your desktop like mine)
*   An MD5 hash beginning with **7ce4**

Save the image with the filename "**Lab2.2 14g YOUR NAME**".

![image](https://github.com/Cyber-Security-Club-HTU/CSC-Malware-Analysis/assets/75253629/50bef837-fe49-4fb0-97f2-ffbeb9013bc6)

Turning in your Lab
-----------------------

Email the images to csc@htu.edu.jo with the subject line: **Lab 2.2  YOUR NAME**

